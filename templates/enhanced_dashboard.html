<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .glass-morphism {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.08);
        }
        .profit-positive { color: #059669; }
        .profit-negative { color: #dc2626; }
        .position-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        .position-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .position-card.profit {
            border-left-color: #059669;
        }
        .position-card.loss {
            border-left-color: #dc2626;
        }
        .metric-card {
            background: linear-gradient(135deg, #93c5fd 0%, #60a5fa 100%);
            transition: transform 0.3s ease;
            padding: 12px;
        }
        .metric-card:hover {
            transform: translateY(-2px);
        }
        .status-indicator {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .sidebar {
            background: #f8fafc;
            border-right: 1px solid #e2e8f0;
        }
        .ticker-item {
            transition: background-color 0.2s ease;
        }
        .ticker-item:hover {
            background-color: #f1f5f9;
        }
        .main-content {
            background: #ffffff;
        }
        .header-bg {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="sidebar w-80 overflow-y-auto">
            <!-- Control Buttons -->
            <div class="glass-morphism rounded-xl p-4 mb-4">
                <div class="flex flex-wrap gap-3 justify-center mb-3">
                    <button onclick="startBot()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors text-sm">
                        <i class="fas fa-play"></i>
                    </button>
                    <button onclick="stopBot()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors text-sm">
                        <i class="fas fa-stop"></i>
                    </button>
                    <button onclick="window.location.href='/trades'" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors text-sm">
                        <i class="fas fa-history"></i>
                    </button>
                </div>
                <div class="flex items-center justify-center gap-2">
                    <input type="checkbox" id="autoRefresh" checked class="w-4 h-4 text-blue-600 rounded">
                    <label for="autoRefresh" class="text-sm text-gray-700 cursor-pointer">Auto-refresh (30s)</label>
                </div>
            </div>
            
            <div class="p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Market Watch</h2>
                
                <!-- Monitored Tickers -->
                <div class="space-y-2" id="monitored-tickers">
                    {% for ticker in monitored_tickers %}
                    <div class="ticker-item p-3 rounded-lg border border-gray-200 hover:shadow-md transition-all">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <p class="font-semibold text-gray-800">{{ ticker.get('symbol', ticker.get('ticker', 'N/A')) }}</p>
                                <p class="text-sm text-gray-600">Rank #{{ ticker.get('rank', loop.index) }}</p>
                                {% if ticker.get('recommendation') %}
                                <span class="inline-block px-2 py-1 text-xs font-medium rounded-full mt-1
                                    {% if ticker.get('recommendation') == 'STRONG BUY' %}bg-green-100 text-green-800
                                    {% elif ticker.get('recommendation') == 'BUY' %}bg-green-50 text-green-700
                                    {% elif ticker.get('recommendation') == 'HOLD' %}bg-yellow-50 text-yellow-700
                                    {% elif ticker.get('recommendation') == 'SELL' %}bg-red-50 text-red-700
                                    {% elif ticker.get('recommendation') == 'STRONG SELL' %}bg-red-100 text-red-800
                                    {% else %}bg-gray-100 text-gray-700{% endif %}">
                                    {{ ticker.get('recommendation') }}
                                </span>
                                {% endif %}
                            </div>
                            <div class="text-right">
                                <p class="font-semibold text-gray-800">${{ "%.2f"|format(ticker.get('price', 0)) }}</p>
                                <p class="text-sm {% if ticker.get('change_pct', 0) > 0 %}profit-positive{% else %}profit-negative{% endif %}">
                                    {{ "%.2f"|format(ticker.get('change_pct', 0)) }}%
                                </p>
                            </div>
                        </div>
                        
                        <!-- Analysis Details -->
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <!-- Quality & Risk -->
                            <div class="flex justify-between">
                                <span class="text-gray-500">Quality:</span>
                                <span class="font-medium">{{ "%.1f"|format(ticker.get('quality_score', 0) * 100) }}%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Risk:</span>
                                <span class="font-medium capitalize">{{ ticker.get('risk_level', 'medium') }}</span>
                            </div>
                            
                            <!-- Technical Indicators -->
                            <div class="flex justify-between">
                                <span class="text-gray-500">RSI:</span>
                                <span class="font-medium {% if ticker.get('rsi', 50) > 70 %}text-red-600{% elif ticker.get('rsi', 50) < 30 %}text-green-600{% else %}text-gray-700{% endif %}">
                                    {{ "%.0f"|format(ticker.get('rsi', 50)) }}
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Momentum:</span>
                                <span class="font-medium {% if ticker.get('momentum', 0) > 0 %}profit-positive{% else %}profit-negative{% endif %}">
                                    {{ "%.2f"|format(ticker.get('momentum', 0)) }}
                                </span>
                            </div>
                            
                            <!-- Risk/Reward -->
                            {% if ticker.get('risk_reward_ratio') %}
                            <div class="flex justify-between col-span-2">
                                <span class="text-gray-500">R/R Ratio:</span>
                                <span class="font-medium {% if ticker.get('risk_reward_ratio', 1) > 2 %}text-green-600{% elif ticker.get('risk_reward_ratio', 1) > 1.5 %}text-blue-600{% elif ticker.get('risk_reward_ratio', 1) < 1 %}text-red-600{% else %}text-gray-700{% endif %}">
                                    {{ "%.2f"|format(ticker.get('risk_reward_ratio', 1)) }}
                                </span>
                            </div>
                            {% endif %}
                            
                            <!-- Manipulation Score -->
                            {% if ticker.get('manipulation_score') is not none %}
                            <div class="flex justify-between col-span-2">
                                <span class="text-gray-500">Manipulation Risk:</span>
                                <span class="font-medium {% if ticker.get('manipulation_score', 0) > 0.7 %}text-red-600{% elif ticker.get('manipulation_score', 0) > 0.4 %}text-yellow-600{% else %}text-green-600{% endif %}">
                                    {{ "%.1f"|format(ticker.get('manipulation_score', 0) * 100) }}%
                                </span>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Volume Info -->
                        {% if ticker.get('volume') %}
                        <div class="mt-2 pt-2 border-t border-gray-100 text-xs text-gray-500">
                            Vol: {{ "{:,}".format(ticker.get('volume', 0)) }}
                            {% if ticker.get('volume_ratio') and ticker.get('volume_ratio') != 1.0 %}
                            <span class="ml-2">(x{{ "%.1f"|format(ticker.get('volume_ratio', 1)) }} avg)</span>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        <!-- Support/Resistance Levels -->
                        {% if ticker.get('support_level') and ticker.get('resistance_level') %}
                        <div class="mt-2 pt-2 border-t border-gray-100 text-xs">
                            <div class="flex justify-between">
                                <span class="text-gray-500">Support:</span>
                                <span class="font-medium text-green-600">${{ "%.2f"|format(ticker.get('support_level', 0)) }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Resistance:</span>
                                <span class="font-medium text-red-600">${{ "%.2f"|format(ticker.get('resistance_level', 0)) }}</span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="text-center py-8">
                        <i class="fas fa-search text-4xl text-gray-300 mb-2"></i>
                        <p class="text-gray-500">No tickers being monitored</p>
                        <p class="text-gray-400 text-sm">Start bot to see monitored tickers</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content flex-1 overflow-y-auto">
            <div class="p-6">
                <!-- Header Stats -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8" id="header-stats">
                    <div class="metric-card rounded-xl p-3 text-white">
                        <div class="text-center">
                            <p class="text-white/80 text-xs font-medium">Portfolio Value</p>
                            <p class="text-xl font-bold mt-1" id="stat-portfolio-value">${{ "%.2f"|format(bot_status.get('current_capital', 0) + positions.get('total_value', 0)) }}</p>
                        </div>
                    </div>
                    
                    <div class="metric-card rounded-xl p-3 text-white">
                        <div class="text-center">
                            <p class="text-white/80 text-xs font-medium">Active Positions</p>
                            <p class="text-xl font-bold mt-1" id="stat-active-positions">{{ positions.get('count', 0) }}</p>
                        </div>
                    </div>
                    
                    <div class="metric-card rounded-xl p-3 text-white">
                        <div class="text-center">
                            <p class="text-white/80 text-xs font-medium">Total Position Value</p>
                            <p class="text-xl font-bold mt-1" id="stat-position-value">${{ "%.2f"|format(positions.get('total_value', 0)) }}</p>
                        </div>
                    </div>
                    
                    <div class="metric-card rounded-xl p-3 text-white">
                        <div class="text-center">
                            <p class="text-white/80 text-xs font-medium">Unrealized P&L</p>
                            <p class="text-xl font-bold mt-1 {% if positions.get('total_unrealized', 0) > 0 %}text-green-300{% else %}text-red-300{% endif %}" id="stat-unrealized-pnl">
                                ${{ "%.2f"|format(positions.get('total_unrealized', 0)) }}
                            </p>
                        </div>
                    </div>
                    
                    <div class="metric-card rounded-xl p-3 text-white">
                        <div class="text-center">
                            <p class="text-white/80 text-xs font-medium">Daily P&L</p>
                            <p class="text-xl font-bold mt-1 {% if bot_status.get('daily_profit', 0) > 0 %}text-green-300{% else %}text-red-300{% endif %}" id="stat-daily-pnl">
                                ${{ "%.2f"|format(bot_status.get('daily_profit', 0)) }}
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Active Positions -->
                <div class="glass-morphism rounded-xl p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Active Positions</h2>
                        <div class="flex items-center gap-2">
                            <span class="status-indicator w-3 h-3 bg-green-500 rounded-full"></span>
                            <span class="text-gray-600 text-sm">Live</span>
                        </div>
                    </div>

                    <div id="positions-container">
                    {% if positions.get('positions', []) %}
                    <div class="overflow-x-auto">
                        <table class="w-full bg-white rounded-xl border border-gray-200">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Ticker</th>
                                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Shares</th>
                                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Entry Price</th>
                                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Current Price</th>
                                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Profit Target</th>
                                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Stop Loss</th>
                                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Current Value</th>
                                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">P&L</th>
                                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">P&L %</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Entry Time</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Pattern</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                {% for pos in positions.get('positions', []) %}
                                <tr class="hover:bg-gray-50 transition-colors {% if pos.get('unrealized_pnl', 0) > 0 %}border-l-4 border-green-500{% else %}border-l-4 border-red-500{% endif %}">
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <div class="flex flex-col">
                                            <span class="text-sm font-bold text-gray-900">{{ pos.get('ticker', 'N/A') }}</span>
                                            <span class="text-xs text-gray-500">{{ pos.get('position_type', 'unknown').title() }}</span>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium text-gray-900">{{ pos.get('shares', 0)|int }}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm text-gray-900">${{ "%.2f"|format(pos.get('entry_price', 0)) }}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm text-gray-900">${{ "%.2f"|format(pos.get('current_price', 0)) }}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium profit-positive">
                                        {% if pos.get('target_price') %}${{ "%.2f"|format(pos.get('target_price', 0)) }}{% else %}-{% endif %}
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium profit-negative">
                                        {% if pos.get('stop_loss') %}${{ "%.2f"|format(pos.get('stop_loss', 0)) }}{% else %}-{% endif %}
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm text-gray-900">${{ "%.2f"|format(pos.get('current_value', 0)) }}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-bold {% if pos.get('unrealized_pnl', 0) > 0 %}profit-positive{% else %}profit-negative{% endif %}">
                                        ${{ "%.2f"|format(pos.get('unrealized_pnl', 0)) }}
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-bold {% if pos.get('unrealized_pnl_pct', 0) > 0 %}profit-positive{% else %}profit-negative{% endif %}">
                                        {{ "%.2f"|format(pos.get('unrealized_pnl_pct', 0) * 100) }}%
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">{{ pos.get('entry_time', 'N/A')[:16] if pos.get('entry_time') else 'N/A' }}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">{{ pos.get('entry_pattern', '-') }}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-center">
                                        <button data-ticker="{{ pos.get('ticker') }}" onclick="closePosition(this.dataset.ticker)" class="bg-red-500/20 hover:bg-red-500/30 text-red-600 px-3 py-1 rounded-lg text-xs font-medium transition-colors">
                                            Close
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-12">
                        <i class="fas fa-chart-line text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-600 text-lg">No active positions</p>
                        <p class="text-gray-400 text-sm mt-2">Start bot to begin trading</p>
                    </div>
                    {% endif %}
                    </div>
                </div>

                <!-- Performance Chart -->
                <div class="glass-morphism rounded-xl p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Performance Overview</h2>
                    <div class="bg-gray-50 rounded-xl p-4">
                        <canvas id="performanceChart" height="100"></canvas>
                    </div>
                </div>

                <!-- Daily Analysis Report -->
                <div class="glass-morphism rounded-xl p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Daily Trade Analysis</h2>
                        <div class="flex gap-2">
                            <button onclick="refreshDailyAnalysis()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-sync-alt mr-2"></i>Refresh
                            </button>
                            <button onclick="runDailyAnalysis()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-play mr-2"></i>Run Analysis
                            </button>
                        </div>
                    </div>
                    
                    <div id="dailyAnalysisContent">
                        <div class="text-center py-8">
                            <i class="fas fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
                            <p class="text-gray-600">Loading daily analysis...</p>
                        </div>
                    </div>
                </div>

                <!-- Completed Trades -->
                <div class="glass-morphism rounded-xl p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Completed Trades</h2>
                        <button onclick="refreshTrades()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                        </button>
                    </div>
                    
                    <div id="completedTradesContent">
                        <div class="text-center py-8">
                            <i class="fas fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
                            <p class="text-gray-600">Loading completed trades...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Performance chart
        const ctx = document.getElementById('performanceChart').getContext('2d');
        
        let performanceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Portfolio Value',
                    data: [],
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Value: $' + context.parsed.y.toFixed(2);
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            color: 'rgba(0, 0, 0, 0.7)'
                        }
                    },
                    y: {
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            color: 'rgba(0, 0, 0, 0.7)',
                            callback: function(value) {
                                return '$' + value.toFixed(0);
                            }
                        }
                    }
                }
            }
        });

        // Function to update performance chart with real data
        function updatePerformanceChart() {
            fetch('/api/chart/equity')
                .then(response => response.json())
                .then(data => {
                    if (data.timestamps && data.equity_values) {
                        performanceChart.data.labels = data.timestamps;
                        performanceChart.data.datasets[0].data = data.equity_values;
                        
                        // Color based on performance
                        const startingCapital = data.starting_capital || data.equity_values[0];
                        const currentValue = data.current_value || data.equity_values[data.equity_values.length - 1];
                        const isProfit = currentValue >= startingCapital;
                        
                        performanceChart.data.datasets[0].borderColor = isProfit ? 'rgb(34, 197, 94)' : 'rgb(239, 68, 68)';
                        performanceChart.data.datasets[0].backgroundColor = isProfit ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)';
                        
                        performanceChart.update();
                    }
                })
                .catch(error => {
                    console.error('Error updating performance chart:', error);
                });
        }

        // Initial load
        updatePerformanceChart();
        refreshTrades();

        // Completed Trades Functions
        function refreshTrades() {
            fetch('/api/trades?limit=100')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showNotification('Error loading trades: ' + data.error, 'error');
                        return;
                    }
                    displayCompletedTrades(data);
                })
                .catch(error => {
                    console.error('Error loading trades:', error);
                    showNotification('Error loading trades', 'error');
                });
        }

        function displayCompletedTrades(data) {
            const container = document.getElementById('completedTradesContent');
            
            // Handle array or object format
            const trades = Array.isArray(data) ? data : (data.trades || []);
            
            if (!trades || trades.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-chart-line text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-600 text-lg">No completed trades</p>
                        <p class="text-gray-400 text-sm mt-2">Completed trades will appear here</p>
                    </div>
                `;
                return;
            }

            // Build table HTML
            let html = `
                <div class="overflow-x-auto">
                    <table class="w-full bg-white rounded-xl border border-gray-200">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Ticker</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Shares</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Entry Price</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Exit Price</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Entry Time</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Exit Time</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Duration</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">P&L</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">P&L %</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Pattern</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Exit Reason</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
            `;

            trades.forEach(trade => {
                if (!trade.ticker) return;
                
                const pnl = trade.pnl || trade.pnl_dollars || 0;
                const pnlPct = trade.pnl_pct || 0;
                const status = pnl > 0 ? 'WIN' : (pnl < 0 ? 'LOSS' : 'BREAKEVEN');
                const statusClass = pnl > 0 ? 'profit-positive' : (pnl < 0 ? 'profit-negative' : 'text-gray-500');
                const borderClass = pnl > 0 ? 'border-l-4 border-green-500' : (pnl < 0 ? 'border-l-4 border-red-500' : 'border-l-4 border-gray-300');
                
                // Format dates
                const entryTime = trade.entry_time ? new Date(trade.entry_time).toLocaleString() : 'N/A';
                const exitTime = trade.exit_time ? new Date(trade.exit_time).toLocaleString() : 'N/A';
                
                // Calculate duration
                let duration = 'N/A';
                if (trade.entry_time && trade.exit_time) {
                    try {
                        const entry = new Date(trade.entry_time);
                        const exit = new Date(trade.exit_time);
                        const diffMs = exit - entry;
                        const diffMins = Math.floor(diffMs / 60000);
                        if (diffMins < 60) {
                            duration = `${diffMins}m`;
                        } else if (diffMins < 1440) {
                            const hours = Math.floor(diffMins / 60);
                            const mins = diffMins % 60;
                            duration = `${hours}h ${mins}m`;
                        } else {
                            const days = Math.floor(diffMins / 1440);
                            const hours = Math.floor((diffMins % 1440) / 60);
                            duration = `${days}d ${hours}h`;
                        }
                    } catch (e) {
                        duration = trade.duration || 'N/A';
                    }
                } else if (trade.duration) {
                    duration = trade.duration;
                }

                html += `
                    <tr class="hover:bg-gray-50 transition-colors ${borderClass}">
                        <td class="px-4 py-3 whitespace-nowrap">
                            <span class="text-sm font-bold text-gray-900">${trade.ticker}</span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium text-gray-900">${Math.round(trade.shares || 0)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm text-gray-900">$${(trade.entry_price || 0).toFixed(2)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm text-gray-900">$${(trade.exit_price || 0).toFixed(2)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-right text-xs text-gray-600">${entryTime}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-right text-xs text-gray-600">${exitTime}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm text-gray-600">${duration}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-bold ${statusClass}">$${pnl.toFixed(2)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-bold ${statusClass}">${(pnlPct * 100).toFixed(2)}%</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${trade.entry_pattern || 'N/A'}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${trade.exit_reason || 'N/A'}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-center">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass} ${pnl > 0 ? 'bg-green-100' : (pnl < 0 ? 'bg-red-100' : 'bg-gray-100')}">
                                ${status}
                            </span>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        // Bot control functions
        function startBot() {
            fetch('/api/start', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success || data.status === 'success') {
                        showNotification('Bot started successfully!', 'success');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showNotification('Error starting bot: ' + (data.error || data.message), 'error');
                    }
                });
        }

        function stopBot() {
            fetch('/api/stop', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success || data.status === 'success') {
                        showNotification('Bot stopped successfully!', 'success');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showNotification('Error stopping bot: ' + (data.error || data.message), 'error');
                    }
                });
        }

        function closePosition(ticker) {
            if (confirm('Are you sure you want to close position ' + ticker + '?')) {
                fetch('/api/position/close', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ticker: ticker })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success || data.status === 'success') {
                        showNotification('Position ' + ticker + ' closed successfully!', 'success');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showNotification('Error closing position: ' + (data.error || data.message), 'error');
                    }
                });
            }
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 p-4 rounded-lg text-white font-medium z-50 ' +
                (type === 'success' ? 'bg-green-500' : 'bg-red-500');
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Daily Analysis Functions
        function refreshDailyAnalysis() {
            fetch('/api/daily-analysis')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showNotification('Error loading daily analysis: ' + data.error, 'error');
                        return;
                    }
                    displayDailyAnalysis(data);
                })
                .catch(error => {
                    console.error('Error loading daily analysis:', error);
                    showNotification('Error loading daily analysis', 'error');
                });
        }

        function runDailyAnalysis() {
            const button = event.target;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Running...';
            
            fetch('/api/daily-analysis/run', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-play mr-2"></i>Run Analysis';
                
                if (data.error) {
                    showNotification('Error running analysis: ' + data.error, 'error');
                    return;
                }
                
                displayDailyAnalysis(data);
                showNotification('Daily analysis completed successfully!', 'success');
            })
            .catch(error => {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-play mr-2"></i>Run Analysis';
                console.error('Error running analysis:', error);
                showNotification('Error running analysis', 'error');
            });
        }

        function displayDailyAnalysis(data) {
            const container = document.getElementById('dailyAnalysisContent');
            
            // Handle no report available status
            if (data.status === 'no_report') {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-chart-line text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-600 text-lg">${data.message}</p>
                        <p class="text-gray-400 text-sm mt-2">Date: ${data.date}</p>
                    </div>
                `;
                return;
            }
            
            if (!data || data.total_trades === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-chart-line text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-600 text-lg">No trades analyzed for ${data.date || 'today'}</p>
                        <p class="text-gray-400 text-sm mt-2">Run analysis or wait for trades to execute</p>
                    </div>
                `;
                return;
            }

            const pnlClass = data.total_pnl >= 0 ? 'profit-positive' : 'profit-negative';
            const winRateClass = data.win_rate >= 50 ? 'profit-positive' : 'profit-negative';
            
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <!-- Key Metrics -->
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-blue-600 font-medium">Total P&L</p>
                                <p class="text-2xl font-bold ${pnlClass}">$${data.total_pnl.toFixed(2)}</p>
                            </div>
                            <i class="fas fa-dollar-sign text-2xl text-blue-500"></i>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-green-600 font-medium">Win Rate</p>
                                <p class="text-2xl font-bold ${winRateClass}">${data.win_rate.toFixed(1)}%</p>
                            </div>
                            <i class="fas fa-trophy text-2xl text-green-500"></i>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-purple-600 font-medium">Total Trades</p>
                                <p class="text-2xl font-bold text-gray-800">${data.total_trades}</p>
                            </div>
                            <i class="fas fa-chart-bar text-2xl text-purple-500"></i>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-orange-600 font-medium">Profit Factor</p>
                                <p class="text-2xl font-bold text-gray-800">${data.profit_factor.toFixed(2)}</p>
                            </div>
                            <i class="fas fa-balance-scale text-2xl text-orange-500"></i>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Performance Details -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Performance Details</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Winning Trades</span>
                                <span class="font-medium">${data.winning_trades}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Losing Trades</span>
                                <span class="font-medium">${data.losing_trades}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Average Win</span>
                                <span class="font-medium profit-positive">$${data.avg_win.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Average Loss</span>
                                <span class="font-medium profit-negative">$${data.avg_loss.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Largest Win</span>
                                <span class="font-medium profit-positive">$${data.largest_win.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Largest Loss</span>
                                <span class="font-medium profit-negative">$${data.largest_loss.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Avg Hold Time</span>
                                <span class="font-medium">${data.avg_hold_time.toFixed(1)} min</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Sharpe Ratio</span>
                                <span class="font-medium">${data.sharpe_ratio.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Max Drawdown</span>
                                <span class="font-medium profit-negative">$${data.max_drawdown.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Pattern Performance -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Pattern Analysis</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Best Pattern</span>
                                <span class="font-medium profit-positive">${data.best_pattern}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Worst Pattern</span>
                                <span class="font-medium profit-negative">${data.worst_pattern}</span>
                            </div>
                        </div>
                        
                        ${Object.keys(data.pattern_performance || {}).length > 0 ? `
                            <div class="mt-4">
                                <h4 class="text-sm font-semibold text-gray-700 mb-2">Pattern Breakdown</h4>
                                <div class="space-y-2">
                                    ${Object.entries(data.pattern_performance).map(([pattern, stats]) => `
                                        <div class="flex justify-between text-sm">
                                            <span class="text-gray-600">${pattern}</span>
                                            <div class="text-right">
                                                <span class="font-medium">${stats.trades} trades</span>
                                                <span class="ml-2 ${stats.total_pnl >= 0 ? 'profit-positive' : 'profit-negative'}">
                                                    $${stats.total_pnl.toFixed(2)}
                                                </span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>

                ${data.recommendations && data.recommendations.length > 0 ? `
                    <div class="mt-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-yellow-800 mb-3">
                            <i class="fas fa-lightbulb mr-2"></i>Recommendations
                        </h3>
                        <ul class="space-y-2">
                            ${data.recommendations.map(rec => `
                                <li class="flex items-start">
                                    <i class="fas fa-chevron-right text-yellow-600 mt-1 mr-2 text-sm"></i>
                                    <span class="text-yellow-800">${rec}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                ` : ''}

                <div class="mt-4 text-center text-sm text-gray-500">
                    Analysis for ${data.date} | Generated at ${new Date().toLocaleTimeString()}
                </div>
            `;
        }

        // Auto-refresh state
        let autoRefreshInterval = null;
        let autoRefreshEnabled = true;

        // Load daily analysis on page load
        document.addEventListener('DOMContentLoaded', function() {
            refreshDailyAnalysis();
            // Initial refresh of dashboard data
            refreshDashboard();
            // Start auto-refresh
            startAutoRefresh();
        });

        // Auto-refresh toggle
        const autoRefreshCheckbox = document.getElementById('autoRefresh');
        if (autoRefreshCheckbox) {
            autoRefreshCheckbox.addEventListener('change', function(e) {
                autoRefreshEnabled = e.target.checked;
                if (autoRefreshEnabled) {
                    startAutoRefresh();
                } else {
                    stopAutoRefresh();
                }
            });
        }

        function startAutoRefresh() {
            stopAutoRefresh(); // Clear any existing interval
            // Refresh every 30 seconds
            autoRefreshInterval = setInterval(() => {
                if (autoRefreshEnabled) {
                    refreshDashboard();
                }
            }, 30000);
            console.log('Auto-refresh started (30s interval)');
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log('Auto-refresh stopped');
            }
        }
        
        function refreshDashboard() {
            console.log('Refreshing dashboard at', new Date().toLocaleTimeString());
            
            // Fetch all data in parallel
            Promise.all([
                fetch('/api/status').then(r => r.json()).catch(e => { console.error('Error fetching status:', e); return {}; }),
                fetch('/api/positions').then(r => r.json()).catch(e => { console.error('Error fetching positions:', e); return {positions: [], count: 0, total_value: 0, total_unrealized: 0}; }),
                fetch('/api/tickers').then(r => r.json()).catch(e => { console.error('Error fetching tickers:', e); return {tickers: []}; })
            ])
            .then(([statusData, positionsData, tickersData]) => {
                // Update header stats
                updateHeaderStats(statusData, positionsData);
                
                // Update positions
                updatePositions(positionsData);
                
                // Update Market Watch list
                const tickers = tickersData.tickers || tickersData || [];
                updateMonitoredTickers(tickers);
                
                // Update performance chart
                updatePerformanceChart();
                
                // Update completed trades
                refreshTrades();
                
                console.log('Dashboard refreshed successfully:', {
                    positions: positionsData.count || 0,
                    tickers: tickers.length,
                    time: new Date().toLocaleTimeString()
                });
            })
            .catch(error => {
                console.error('Error refreshing dashboard:', error);
            });
        }

        function updateHeaderStats(statusData, positionsData) {
            // Use portfolio_value from status API if available, otherwise calculate
            const portfolioValue = statusData.portfolio_value || ((statusData.current_capital || 0) + (positionsData.total_value || 0));
            const unrealizedPnl = positionsData.total_unrealized || 0;
            const dailyPnl = statusData.daily_profit || 0;
            
            const portfolioEl = document.getElementById('stat-portfolio-value');
            const positionsEl = document.getElementById('stat-active-positions');
            const positionValueEl = document.getElementById('stat-position-value');
            const unrealizedEl = document.getElementById('stat-unrealized-pnl');
            const dailyPnlEl = document.getElementById('stat-daily-pnl');
            
            if (portfolioEl) portfolioEl.textContent = '$' + portfolioValue.toFixed(2);
            if (positionsEl) positionsEl.textContent = positionsData.count || 0;
            if (positionValueEl) positionValueEl.textContent = '$' + (positionsData.total_value || 0).toFixed(2);
            
            if (unrealizedEl) {
                unrealizedEl.textContent = '$' + unrealizedPnl.toFixed(2);
                unrealizedEl.className = 'text-xl font-bold mt-1 ' + (unrealizedPnl > 0 ? 'text-green-300' : 'text-red-300');
            }
            
            if (dailyPnlEl) {
                dailyPnlEl.textContent = '$' + dailyPnl.toFixed(2);
                dailyPnlEl.className = 'text-xl font-bold mt-1 ' + (dailyPnl > 0 ? 'text-green-300' : 'text-red-300');
            }
        }

        function updatePositions(positionsData) {
            const container = document.getElementById('positions-container');
            if (!container) return;
            
            const positions = positionsData.positions || [];
            
            if (positions.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-chart-line text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-600 text-lg">No active positions</p>
                        <p class="text-gray-400 text-sm mt-2">Start bot to begin trading</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full bg-white rounded-xl border border-gray-200">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Ticker</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Shares</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Entry Price</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Current Price</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Profit Target</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Stop Loss</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Current Value</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">P&L</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">P&L %</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Entry Time</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Pattern</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${positions.map(pos => `
                                <tr class="hover:bg-gray-50 transition-colors ${(pos.unrealized_pnl || 0) > 0 ? 'border-l-4 border-green-500' : 'border-l-4 border-red-500'}">
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <div class="flex flex-col">
                                            <span class="text-sm font-bold text-gray-900">${pos.ticker || 'N/A'}</span>
                                            <span class="text-xs text-gray-500">${(pos.position_type || 'unknown').charAt(0).toUpperCase() + (pos.position_type || 'unknown').slice(1)}</span>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium text-gray-900">${Math.round(pos.shares || 0)}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm text-gray-900">$${(pos.entry_price || 0).toFixed(2)}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm text-gray-900">$${(pos.current_price || 0).toFixed(2)}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium profit-positive">
                                        ${pos.target_price ? '$' + (pos.target_price || 0).toFixed(2) : '-'}
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium profit-negative">
                                        ${pos.stop_loss ? '$' + (pos.stop_loss || 0).toFixed(2) : '-'}
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm text-gray-900">$${(pos.current_value || 0).toFixed(2)}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-bold ${(pos.unrealized_pnl || 0) > 0 ? 'profit-positive' : 'profit-negative'}">
                                        $${(pos.unrealized_pnl || 0).toFixed(2)}
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-bold ${(pos.unrealized_pnl_pct || 0) > 0 ? 'profit-positive' : 'profit-negative'}">
                                        ${((pos.unrealized_pnl_pct || 0) * 100).toFixed(2)}%
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${(pos.entry_time || 'N/A').substring(0, 16)}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${pos.entry_pattern || '-'}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-center">
                                        <button data-ticker="${pos.ticker}" onclick="closePosition(this.dataset.ticker)" class="bg-red-500/20 hover:bg-red-500/30 text-red-600 px-3 py-1 rounded-lg text-xs font-medium transition-colors">
                                            Close
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function updateMonitoredTickers(tickersData) {
            const tickerContainer = document.getElementById('monitored-tickers');
            if (!tickerContainer) return;
            
            // Ensure tickersData is an array
            const tickers = Array.isArray(tickersData) ? tickersData : [];
            
            if (tickers.length === 0) {
                tickerContainer.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-search text-4xl text-gray-300 mb-2"></i>
                        <p class="text-gray-500">No tickers being monitored</p>
                        <p class="text-gray-400 text-sm">Start bot to see monitored tickers</p>
                    </div>
                `;
                return;
            }
            
            tickerContainer.innerHTML = tickers.map((ticker, index) => `
                <div class="ticker-item p-3 rounded-lg border border-gray-200">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-semibold text-gray-800">${ticker.symbol || ticker.ticker || 'N/A'}</p>
                            <p class="text-sm text-gray-600">Rank #${ticker.rank || index + 1}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-semibold text-gray-800">$${ticker.price.toFixed(2)}</p>
                            <p class="text-sm ${ticker.change_pct > 0 ? 'profit-positive' : 'profit-negative'}">
                                ${ticker.change_pct.toFixed(2)}%
                            </p>
                        </div>
                    </div>
                    ${ticker.volume ? `
                        <div class="mt-2 text-xs text-gray-500">
                            Vol: ${ticker.volume.toLocaleString()}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
    </script>
</body>
</html>
